<!doctype html>
<html lang="de" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>ZONA BALKO ‚Äì Marktplatz</title>
  
  <style>
    /* --- RAI DESIGN SYSTEM --- */
    :root {
      /* LIGHT MODE */
      --bg-body: #F2F2F7;       
      --bg-card: #FFFFFF;
      --bg-input: #E5E5EA;      
      --text-primary: #000000;
      --text-secondary: #8E8E93;
      --separator: #C6C6C8;     
      --accent: #007AFF;        
      --danger: #FF3B30;        
      --success: #34C759;
      --warning: #FF9500;       
      
      --radius-l: 24px;         
      --radius-m: 16px;         
      --shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      --font: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      --nav-height: 60px;
      --max-width: 900px;
    }

    [data-theme="dark"] {
      /* DARK MODE */
      --bg-body: #000000;
      --bg-card: #1C1C1E;       
      --bg-input: #2C2C2E;
      --text-primary: #FFFFFF;
      --text-secondary: #98989D;
      --separator: #38383A;
      --accent: #0A84FF;
      --shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    body {
      background-color: var(--bg-body);
      color: var(--text-primary);
      font-family: var(--font);
      -webkit-font-smoothing: antialiased;
      padding-bottom: 120px; padding-top: env(safe-area-inset-top);
      transition: background-color 0.3s ease;
    }

    button, input, select, textarea { font-family: inherit; border: none; outline: none; }
    a { text-decoration: none; color: inherit; cursor: pointer; }
    .wrap { max-width: var(--max-width); margin: 0 auto; padding: 0 20px; }
    .hidden { display: none !important; }

    /* TOAST */
    .toast-container {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      z-index: 3000; display: flex; flex-direction: column; gap: 10px; pointer-events: none;
    }
    .toast {
      background: rgba(50, 50, 50, 0.9); backdrop-filter: blur(10px);
      color: #fff; padding: 12px 24px; border-radius: 50px;
      font-size: 14px; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      opacity: 0; transform: translateY(-20px); transition: 0.3s;
    }
    .toast.show { opacity: 1; transform: translateY(0); }

    /* HEADER */
    .navbar {
      position: sticky; top: 0; z-index: 1000; height: var(--nav-height);
      background: rgba(255, 255, 255, 0.0); display: flex; align-items: center; justify-content: center;
      margin-bottom: 10px; pointer-events: none; 
    }
    .nav-inner { 
      pointer-events: auto; width: 100%; display: flex; justify-content: space-between; align-items: center; 
      background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      padding: 10px 20px; border-radius: 0 0 24px 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }
    [data-theme="dark"] .nav-inner { background: rgba(28, 28, 30, 0.85); }

    .logo { 
      font-weight: 800; font-size: 20px; letter-spacing: 0.5px; 
      color: var(--text-primary); cursor: pointer; user-select: none; text-transform: uppercase; white-space: nowrap;
    }
    .logo span { color: var(--accent); }
    .nav-controls { display: flex; gap: 12px; align-items: center; }

    .lang-select {
      background: var(--bg-input); color: var(--text-primary);
      font-size: 13px; font-weight: 700; padding: 0 12px; height: 36px;
      border-radius: 18px; cursor: pointer; appearance: none; text-align: center; border: 1px solid transparent;
    }
    .theme-toggle {
      width: 36px; height: 36px; border-radius: 50%;
      background: var(--bg-input); color: var(--text-primary);
      display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px;
    }

    /* COMPONENTS */
    .rai-input-group { margin-bottom: 20px; }
    .rai-label {
      display: block; font-size: 11px; text-transform: uppercase; font-weight: 700;
      color: var(--text-secondary); margin-bottom: 8px; margin-left: 12px; letter-spacing: 0.5px;
    }
    .rai-input {
      width: 100%; height: 54px; padding: 0 16px; background: var(--bg-card); color: var(--text-primary);
      border-radius: var(--radius-m); font-size: 17px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); transition: 0.2s;
    }
    .rai-input:focus { box-shadow: 0 0 0 2px var(--accent); transform: scale(1.01); }
    textarea.rai-input { height: auto; padding-top: 16px; min-height: 140px; resize: none; }
    select.rai-input { appearance: none; background-repeat: no-repeat; background-position: right 16px center; background-size: 18px; 
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%238E8E93' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    }

    .rai-card {
      background: var(--bg-card); border-radius: var(--radius-l); padding: 24px; box-shadow: var(--shadow); margin-bottom: 24px; overflow: hidden;
    }

    .rai-btn {
      width: 100%; height: 56px; background: var(--accent); color: #fff; font-size: 17px; font-weight: 700;
      border-radius: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer;
      transition: transform 0.1s, opacity 0.2s, box-shadow 0.2s; box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
    }
    .rai-btn:active { transform: scale(0.96); opacity: 0.9; }
    .rai-btn.secondary { background: var(--bg-input); color: var(--text-primary); box-shadow: none; }
    .rai-btn.danger { background: rgba(255, 59, 48, 0.1); color: var(--danger); box-shadow: none; }
    .rai-btn.google { background: #fff; color: #000; border: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    [data-theme="dark"] .rai-btn.google { background: #fff; color: #000; }
    
    .rai-btn.small { height: 36px; font-size: 13px; padding: 0 16px; width: auto; display: inline-flex; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    @media (max-width: 600px) { .grid-4 { grid-template-columns: 1fr 1fr; } }

    /* MARKET VIEW */
    .market-header { margin: 20px 0 30px 0; text-align: left; padding: 0 10px; }
    .market-title { font-size: 34px; font-weight: 800; margin-bottom: 4px; letter-spacing: -1px; }
    .market-subtitle { color: var(--text-secondary); font-size: 17px; font-weight: 500; }

    .search-wrapper { position: relative; margin-bottom: 24px; }
    .search-input { background: var(--bg-card); border-radius: 20px; padding-left: 50px; height: 60px; font-size: 18px; }
    .search-icon { position: absolute; left: 18px; top: 20px; color: var(--accent); font-size: 20px; }

    .adv-filter-box {
      margin-top: 16px; padding: 20px; background: var(--bg-card); border: 1px solid var(--accent);
      border-radius: var(--radius-m); display: none; box-shadow: var(--shadow);
    }
    .adv-filter-box.show { display: block; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes popIn { from{opacity:0; transform:scale(0.95)} to{opacity:1; transform:scale(1)} }

    .listing-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 30px; }
    @media (min-width: 600px) { .listing-grid { grid-template-columns: repeat(3, 1fr); } }

    .empty-state { grid-column: 1 / -1; padding: 60px 0; text-align: center; color: var(--text-secondary); }
    .empty-icon { font-size: 60px; margin-bottom: 16px; opacity: 0.2; filter: grayscale(1); }

    .upload-box {
      aspect-ratio: 1; background: var(--bg-input); border-radius: var(--radius-m);
      display: flex; align-items: center; justify-content: center; font-size: 28px; color: var(--text-secondary); cursor: pointer; transition: 0.2s;
      position: relative; overflow: hidden;
    }
    .upload-box img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
    .upload-box.main { border: 2px dashed var(--accent); color: var(--accent); background: rgba(0, 122, 255, 0.05); }

    /* DASHBOARD / PROFILE */
    .dashboard-header { text-align: center; padding: 40px 0 20px; }
    .dash-avatar-wrapper { 
      position: relative; width: 120px; height: 120px; margin: 0 auto 16px; 
    }
    .dash-avatar {
      width: 100%; height: 100%; border-radius: 50%; background: var(--bg-input); 
      background-size: cover; background-position: center; border: 4px solid var(--bg-card);
      box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center; font-size: 50px;
    }
    .dash-edit-badge {
      position: absolute; bottom: 0; right: 0; width: 36px; height: 36px;
      background: var(--accent); color: #fff; border-radius: 50%; border: 3px solid var(--bg-card);
      display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer;
    }

    .dash-stats {
      display: flex; justify-content: center; gap: 20px; margin-bottom: 30px;
    }
    .stat-pill {
      background: var(--bg-card); padding: 10px 20px; border-radius: 20px; box-shadow: var(--shadow);
      display: flex; flex-direction: column; align-items: center; min-width: 100px;
    }
    .stat-val { font-size: 18px; font-weight: 800; color: var(--text-primary); }
    .stat-lbl { font-size: 12px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; }

    .dash-section-title { font-size: 18px; font-weight: 700; margin-bottom: 15px; margin-top: 30px; padding-left: 10px; }

    /* OVERLAYS */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
      z-index: 5000; display: none; align-items: center; justify-content: center; padding: 20px;
    }
    .modal-box {
      background: var(--bg-card); width: 100%; max-width: 400px; max-height: 85vh; overflow-y: auto;
      border-radius: var(--radius-l); padding: 24px; box-shadow: var(--shadow);
      animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .auth-title { font-size: 22px; font-weight: 800; margin-bottom: 20px; text-align: center; }

    /* DOCK */
    .tab-bar-container { position: fixed; bottom: 30px; left: 0; right: 0; z-index: 2000; display: flex; justify-content: center; pointer-events: none; }
    .tab-bar {
      pointer-events: auto; height: 70px; background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border-radius: 35px;
      display: flex; align-items: center; justify-content: space-between; padding: 0 10px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.2); min-width: 280px;
    }
    [data-theme="dark"] .tab-bar { background: rgba(40, 40, 42, 0.85); border-color: rgba(255,255,255,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
    .tab-item {
      width: 60px; height: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center;
      color: var(--text-secondary); cursor: pointer; border-radius: 50%; transition: all 0.25s;
    }
    .tab-icon { font-size: 26px; margin-bottom: 0; transition: transform 0.2s; }
    .tab-item.active { color: #fff; background: var(--accent); transform: translateY(-10px) scale(1.1); box-shadow: 0 6px 15px rgba(0, 122, 255, 0.4); }
    .tab-item:active { transform: scale(0.9); }

  </style>
</head>
<body>

  <div class="toast-container" id="toast-container"></div>
  
  <div class="modal-overlay" id="auth-modal">
    <div class="modal-box">
      <div class="auth-title" id="auth-title">Willkommen</div>
      <button class="rai-btn google" onclick="app.loginGoogle()" style="margin-bottom:15px; display:flex; gap:10px;">
        <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Weiter mit Google
      </button>
      <div style="text-align:center; color:var(--text-secondary); margin:10px 0; font-size:12px;">ODER</div>
      <div class="rai-input-group"><label class="rai-label">Email</label><input type="email" id="auth-email" class="rai-input" placeholder="mail@example.com"></div>
      <div class="rai-input-group"><label class="rai-label">Passwort</label><input type="password" id="auth-pass" class="rai-input" placeholder="******"></div>
      <button class="rai-btn" id="btn-auth-action">Einloggen</button>
      <button class="rai-btn secondary" style="margin-top:10px" id="btn-auth-switch">Kein Konto? Registrieren</button>
      <button class="rai-btn secondary" style="margin-top:10px; background:transparent; border:1px solid var(--separator);" onclick="app.closeModal('auth-modal')">Abbrechen</button>
    </div>
  </div>

  <div class="modal-overlay" id="settings-modal">
    <div class="modal-box">
      <div class="auth-title">Profil bearbeiten</div>
      <div class="rai-input-group">
        <label class="rai-label">Anzeigename</label>
        <input type="text" id="set-name" class="rai-input">
      </div>
      <div class="rai-input-group">
        <label class="rai-label">Telefonnummer</label>
        <input type="tel" id="set-phone" class="rai-input" placeholder="+41 79 ...">
      </div>
      <div class="rai-input-group">
        <label class="rai-label">Nummer anzeigen f√ºr</label>
        <select id="set-privacy" class="rai-input">
          <option value="registered">Nur Registrierte (Empfohlen)</option>
          <option value="public">Alle (√ñffentlich)</option>
          <option value="hidden">Niemand (Verbergen)</option>
        </select>
      </div>
      <button class="rai-btn" onclick="app.saveSettings()">Speichern</button>
      <button class="rai-btn secondary" style="margin-top:10px; background:transparent;" onclick="app.closeModal('settings-modal')">Abbrechen</button>
    </div>
  </div>

  <input type="file" id="avatar-input" hidden accept="image/*">

  <nav class="navbar">
    <div class="wrap nav-inner">
      <div class="logo" onclick="app.nav('market')">ZONA BALKO<span>.</span></div>
      <div class="nav-controls">
        <select class="lang-select" id="lang-switcher" onchange="app.setLanguage(this.value)">
          <option value="de">DE</option>
          <option value="en">EN</option>
          <option value="sq">SQ</option>
          <option value="sr">SR</option>
          <option value="mk">MK</option>
        </select>
        <div class="theme-toggle" onclick="app.toggleTheme()">
          <span id="theme-icon">üåô</span>
        </div>
      </div>
    </div>
  </nav>

  <main class="wrap">
    
    <section id="view-market">
      <div class="market-header">
        <div class="market-title" data-i18n="market_title">Entdecken</div>
        <div class="market-subtitle" data-i18n="market_subtitle">Finde Angebote im Balkan (Alle Preise in ‚Ç¨)</div>
      </div>

      <div class="search-wrapper">
        <span class="search-icon">üîç</span>
        <input type="text" class="rai-input search-input" id="search-input" placeholder="" data-i18n-placeholder="search_ph" oninput="app.loadListings()">
      </div>

      <div class="grid-2" style="margin-bottom: 16px;">
        <div class="rai-input-group" style="margin:0;">
          <label class="rai-label" data-i18n="label_country">Land</label>
          <select class="rai-input" id="filter-country" onchange="app.loadListings()"></select>
        </div>
        <div class="rai-input-group" style="margin:0;">
          <label class="rai-label" data-i18n="label_category">Kategorie</label>
          <select class="rai-input" id="filter-cat"></select>
        </div>
      </div>

      <div class="grid-2">
        <div class="rai-input-group" style="margin:0;">
          <label class="rai-label" data-i18n="label_region">Region / Stadt</label>
          <input type="text" class="rai-input" id="filter-region" placeholder="" data-i18n-placeholder="region_ph" oninput="app.loadListings()">
        </div>
        <div class="rai-input-group" style="margin:0;">
          <label class="rai-label" data-i18n="label_subcategory">Unterkategorie</label>
          <select class="rai-input" id="filter-sub" disabled onchange="app.loadListings()">
            <option data-i18n="opt_all">Alle</option>
          </select>
        </div>
      </div>

      <div id="dynamic-filters" class="adv-filter-box"></div>

      <div class="listing-grid" id="market-listings">
        <div class="empty-state">
          <div class="empty-icon">üõí</div>
          <div data-i18n="empty_results">Hier ist es leer.<br><small>Warte auf Daten...</small></div>
        </div>
      </div>
    </section>

    <section id="view-sell" class="hidden">
      <div class="market-header">
        <div class="market-title" data-i18n="nav_sell">Verkaufen</div>
        <div class="market-subtitle" data-i18n="sell_subtitle">Inserat aufgeben</div>
      </div>

      <input type="file" id="upload-input" hidden accept="image/*">

      <div class="rai-card">
        <div class="rai-label" style="margin-bottom:12px;" data-i18n="label_photos">Fotos (Max 8)</div>
        <div class="grid-4" id="upload-grid">
          <div class="upload-box main" onclick="app.triggerUpload(0)">üì∑</div>
          <div class="upload-box" onclick="app.triggerUpload(1)">+</div>
          <div class="upload-box" onclick="app.triggerUpload(2)">+</div>
          <div class="upload-box" onclick="app.triggerUpload(3)">+</div>
        </div>
      </div>

      <div class="rai-card">
        <div class="rai-input-group">
          <label class="rai-label" data-i18n="label_title">Titel</label>
          <input type="text" class="rai-input" id="sell-title" placeholder="" data-i18n-placeholder="title_ph">
        </div>

        <div class="grid-2">
           <div class="rai-input-group">
            <label class="rai-label" data-i18n="label_country">Land</label>
            <select class="rai-input" id="sell-country"></select>
          </div>
          <div class="rai-input-group">
            <label class="rai-label" data-i18n="label_price">Preis (‚Ç¨)</label>
            <input type="number" class="rai-input" id="sell-price" placeholder="0">
          </div>
        </div>

        <div class="grid-2">
          <div class="rai-input-group">
            <label class="rai-label" data-i18n="label_category">Kategorie</label>
            <select class="rai-input" id="sell-cat"></select>
          </div>
          <div class="rai-input-group">
            <label class="rai-label" data-i18n="label_subcategory">Unterkategorie</label>
            <select class="rai-input" id="sell-sub" disabled>
              <option data-i18n="opt_choose">W√§hlen...</option>
            </select>
          </div>
        </div>

        <div id="sell-dynamic-inputs" class="grid-2" style="margin-bottom: 20px; display:none;"></div>

        <div class="rai-input-group">
          <label class="rai-label" data-i18n="label_description">Beschreibung</label>
          <textarea class="rai-input" id="sell-desc" placeholder="" data-i18n-placeholder="desc_ph"></textarea>
        </div>

        <button class="rai-btn" data-i18n="btn_publish" onclick="app.publishListing()">Ver√∂ffentlichen</button>
      </div>
    </section>

    <section id="view-profile" class="hidden">
      <div id="profile-content-logged-in" style="display:none;">
        <div class="dashboard-header">
          <div class="dash-avatar-wrapper">
            <div class="dash-avatar" id="dash-avatar">üë§</div>
            <div class="dash-edit-badge" onclick="app.triggerAvatarUpload()">‚úé</div>
          </div>
          <div class="market-title" id="dash-name" style="font-size:24px;">Name</div>
          <div class="market-subtitle" id="dash-email">email@example.com</div>
          <div style="margin-top:10px;">
            <button class="rai-btn secondary small" onclick="app.removeAvatar()" style="color:var(--danger)">Bild entfernen</button>
          </div>
        </div>

        <div class="dash-stats">
          <div class="stat-pill">
            <span class="stat-val" id="stat-listings">0</span>
            <span class="stat-lbl">Inserate</span>
          </div>
          <div class="stat-pill">
            <span class="stat-val">0</span>
            <span class="stat-lbl">Merkliste</span>
          </div>
        </div>

        <div class="dash-section-title">Einstellungen</div>
        <div class="list-group">
          <div class="list-item" onclick="app.openSettings()">
            <div style="display:flex; align-items:center;">
              <span class="list-icon">‚öôÔ∏è</span> Pers√∂nliche Daten & Privatsph√§re
            </div>
            <span class="chevron">‚Ä∫</span>
          </div>
        </div>

        <div class="dash-section-title">Verwaltung</div>
        <div class="list-group">
          <div id="dash-listings-container"></div>
        </div>

        <div style="text-align:center; margin-top:30px;">
          <button class="rai-btn secondary" style="color:var(--danger); width:auto; padding:0 30px;" onclick="app.logout()">Abmelden</button>
        </div>
      </div>

      <div id="profile-content-guest" style="padding-top:60px;">
        <div class="rai-card" style="text-align:center; padding:40px;">
          <div style="font-size:50px; margin-bottom:20px;">üîí</div>
          <h2 style="margin-bottom:10px;">Profil gesch√ºtzt</h2>
          <p style="margin-bottom:30px; color:var(--text-secondary); line-height:1.5;">Melde dich an, um deine Inserate zu verwalten und Kontakt aufzunehmen.</p>
          <button class="rai-btn" onclick="app.openAuth('login')">Anmelden / Registrieren</button>
        </div>
      </div>
    </section>
  </main>

  <div class="tab-bar-container">
    <div class="tab-bar">
      <div class="tab-item active" id="tab-market" onclick="app.nav('market')"><div class="tab-icon">üîç</div></div>
      <div class="tab-item" id="tab-sell" onclick="app.nav('sell')"><div class="tab-icon">‚ûï</div></div>
      <div class="tab-item" id="tab-profile" onclick="app.nav('profile')"><div class="tab-icon">üë§</div></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, doc, setDoc, getDoc, deleteDoc, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCgKSVhDFzoDUs2Sc9jkNoGBTR9Sspu2JE",
      authDomain: "zonabalko.firebaseapp.com",
      projectId: "zonabalko",
      storageBucket: "zonabalko.firebasestorage.app",
      messagingSenderId: "1095024300350",
      appId: "1:1095024300350:web:e436232a2b5cccda58dc6f"
    };

    const fbApp = initializeApp(firebaseConfig);
    const auth = getAuth(fbApp);
    const db = getFirestore(fbApp);
    const googleProvider = new GoogleAuthProvider();

    // --- DATA ---
    const TRANSLATIONS = {
      de: {
        nav_market: "Markt", nav_sell: "Verkaufen", nav_profile: "Profil",
        market_title: "Entdecken", market_subtitle: "Finde Angebote im Balkan (Alle Preise in ‚Ç¨)",
        sell_subtitle: "Inserat aufgeben", profile_title: "Mein Profil", profile_subtitle: "Gast",
        search_ph: "Suche...", label_country: "Land", label_category: "Kategorie", label_region: "Region / Stadt",
        label_subcategory: "Unterkategorie", label_title: "Titel", label_price: "Preis (‚Ç¨)",
        label_description: "Beschreibung", label_photos: "Fotos (Max 8)",
        region_ph: "Ort eingeben", title_ph: "Titel...", desc_ph: "Details...",
        btn_publish: "Ver√∂ffentlichen", btn_logout: "Abmelden", opt_all: "Alle", opt_choose: "W√§hlen...",
        menu_personal: "Pers√∂nliche Daten", menu_listings: "Meine Inserate",
        empty_results: "Keine Ergebnisse.", filter_km: "Kilometer bis", filter_year: "Jahr ab", filter_power: "PS",
        filter_area: "m¬≤", filter_rooms: "Zimmer", filter_floor: "Etage"
      },
      en: {
        nav_market: "Market", nav_sell: "Sell", nav_profile: "Profile",
        market_title: "Discover", market_subtitle: "Find offers in the Balkans (Prices in ‚Ç¨)",
        sell_subtitle: "Post Ad", profile_title: "Profile", profile_subtitle: "Guest", search_ph: "Search...",
        label_country: "Country", label_category: "Category", label_region: "City",
        label_subcategory: "Subcategory", label_title: "Title", label_price: "Price (‚Ç¨)",
        label_description: "Description", label_photos: "Photos", region_ph: "City", title_ph: "Title", desc_ph: "Details",
        btn_publish: "Publish", btn_logout: "Log out", opt_all: "All", opt_choose: "Choose",
        menu_personal: "Data", menu_listings: "Listings",
        empty_results: "No results.", filter_km: "KM", filter_year: "Year", filter_power: "HP",
        filter_area: "m¬≤", filter_rooms: "Rooms", filter_floor: "Floor"
      },
      sq: { nav_market: "Tregu", nav_sell: "Shit", nav_profile: "Profili", market_title: "Zbulo", market_subtitle: "Ballkan (‚Ç¨)", sell_subtitle: "Shit", profile_title: "Profili", profile_subtitle: "Mysafir", search_ph: "K√´rko...", label_country: "Shteti", label_category: "Kategoria", label_region: "Qyteti", label_subcategory: "N√´nkategoria", label_title: "Titulli", label_price: "√ámimi", label_description: "P√´rshkrimi", label_photos: "Foto", region_ph: "Qyteti", title_ph: "Titulli", desc_ph: "Detajet", btn_publish: "Publiko", btn_logout: "Dil", opt_all: "T√´ gjitha", opt_choose: "Zgjidh", menu_personal: "T√´ dh√´nat", menu_listings: "Njoftimet", empty_results: "Asnj√´ rezultat.", filter_km: "KM", filter_year: "Viti", filter_power: "KF", filter_area: "m¬≤", filter_rooms: "Dhoma", filter_floor: "Kati" },
      sr: { nav_market: "Pijaca", nav_sell: "Prodaj", nav_profile: "Profil", market_title: "Otkrij", market_subtitle: "Balkan (‚Ç¨)", sell_subtitle: "Prodaj", profile_title: "Profil", profile_subtitle: "Gost", search_ph: "Pretra≈æi...", label_country: "Dr≈æava", label_category: "Kategorija", label_region: "Grad", label_subcategory: "Podkategorija", label_title: "Naslov", label_price: "Cena", label_description: "Opis", label_photos: "Slike", region_ph: "Grad", title_ph: "Naslov", desc_ph: "Detalji", btn_publish: "Objavi", btn_logout: "Odjavi se", opt_all: "Sve", opt_choose: "Izaberi", menu_personal: "Podaci", menu_listings: "Oglasi", empty_results: "Nema rezultata.", filter_km: "KM", filter_year: "Godi≈°te", filter_power: "KS", filter_area: "m¬≤", filter_rooms: "Soba", filter_floor: "Sprat" },
      mk: { nav_market: "–ü–∞–∑–∞—Ä", nav_sell: "–ü—Ä–æ–¥–∞—ò", nav_profile: "–ü—Ä–æ—Ñ–∏–ª", market_title: "–û—Ç–∫—Ä–∏—ò", market_subtitle: "–ë–∞–ª–∫–∞–Ω (‚Ç¨)", sell_subtitle: "–ü—Ä–æ–¥–∞—ò", profile_title: "–ü—Ä–æ—Ñ–∏–ª", profile_subtitle: "–ì–æ—Å—Ç–∏–Ω", search_ph: "–ë–∞—Ä–∞—ò...", label_country: "–î—Ä–∂–∞–≤–∞", label_category: "–ö–∞—Ç–µ–≥–æ—Ä–∏—ò–∞", label_region: "–ì—Ä–∞–¥", label_subcategory: "–ü–æ—Ç–∫–∞—Ç–µ–≥–æ—Ä–∏—ò–∞", label_title: "–ù–∞—Å–ª–æ–≤", label_price: "–¶–µ–Ω–∞", label_description: "–û–ø–∏—Å", label_photos: "–°–ª–∏–∫–∏", region_ph: "–ì—Ä–∞–¥", title_ph: "–ù–∞—Å–ª–æ–≤", desc_ph: "–î–µ—Ç–∞–ª–∏", btn_publish: "–û–±—ò–∞–≤–∏", btn_logout: "–û–¥—ò–∞–≤–∏ —Å–µ", opt_all: "–°–∏—Ç–µ", opt_choose: "–ò–∑–±–µ—Ä–∏", menu_personal: "–ü–æ–¥–∞—Ç–æ—Ü–∏", menu_listings: "–û–≥–ª–∞—Å–∏", empty_results: "–ù–µ–º–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏.", filter_km: "–ö–ú", filter_year: "–ì–æ–¥–∏–Ω–∞", filter_power: "–ö–°", filter_area: "m¬≤", filter_rooms: "–°–æ–±–∏", filter_floor: "–ö–∞—Ç" }
    };

    const COUNTRIES_DATA = { all: { de: "Alle", en: "All", sq: "T√´ gjitha", sr: "Sve", mk: "–°–∏—Ç–µ" }, al: { de: "Albanien", en: "Albania", sq: "Shqip√´ria", sr: "Albanija", mk: "–ê–ª–±–∞–Ω–∏—ò–∞" }, xk: { de: "Kosovo", en: "Kosovo", sq: "Kosova", sr: "Kosovo", mk: "–ö–æ—Å–æ–≤–æ" }, mk: { de: "Nordmazedonien", en: "North Macedonia", sq: "Maqedonia e V.", sr: "Severna Makedonija", mk: "–°–µ–≤–µ—Ä–Ω–∞ –ú–∞–∫–µ–¥–æ–Ω–∏—ò–∞" }, rs: { de: "Serbien", en: "Serbia", sq: "Serbia", sr: "Srbija", mk: "–°—Ä–±–∏—ò–∞" }, ba: { de: "Bosnien & Herz.", en: "Bosnia & Herz.", sq: "Bosnja", sr: "Bosna", mk: "–ë–æ—Å–Ω–∞" }, hr: { de: "Kroatien", en: "Croatia", sq: "Kroacia", sr: "Hrvatska", mk: "–•—Ä–≤–∞—Ç—Å–∫–∞" }, me: { de: "Montenegro", en: "Montenegro", sq: "Mali i Zi", sr: "Crna Gora", mk: "–¶—Ä–Ω–∞ –ì–æ—Ä–∞" } };

    const CATEGORIES_DATA = {
      vehicles: { label: { de: "Fahrzeuge", en: "Vehicles", sq: "Automjete", sr: "Vozila", mk: "–í–æ–∑–∏–ª–∞" }, subs: [{k:"small",de:"Kleinwagen"},{k:"limo",de:"Limousine"},{k:"wagon",de:"Kombi"},{k:"suv",de:"SUV"},{k:"coupe",de:"Sport/Coupe"},{k:"cabrio",de:"Cabrio"},{k:"moto",de:"Motorrad"},{k:"truck",de:"Nutzfahrzeug"}], filters: [{id:"filter_km"},{id:"filter_year"},{id:"filter_power"}] },
      realestate: { label: { de: "Immobilien", en: "Real Estate", sq: "Patundshm√´ri", sr: "Nekretnine", mk: "–ù–µ–¥–≤–∏–∂–Ω–æ—Å—Ç–∏" }, subs: [{k:"apt_buy",de:"Wohnung (Kauf)"},{k:"apt_rent",de:"Wohnung (Miete)"},{k:"house_buy",de:"Haus (Kauf)"},{k:"house_rent",de:"Haus (Miete)"},{k:"land",de:"Grundst√ºck"},{k:"comm",de:"Gewerbe"},{k:"garage",de:"Garage"}], filters: [{id:"filter_area"}] },
      electronics: { label: { de: "Elektronik", en: "Electronics", sq: "Elektronik√´", sr: "Elektronika", mk: "–ï–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞" }, subs: [{k:"phone",de:"Smartphone"},{k:"laptop",de:"Laptop/PC"},{k:"console",de:"Konsole"},{k:"tv",de:"TV/Audio"},{k:"cam",de:"Kamera"}], filters: [] },
      fashion: { label: { de: "Mode", en: "Fashion", sq: "Moda", sr: "Moda", mk: "–ú–æ–¥–∞" }, subs: [{k:"women",de:"Damen"},{k:"men",de:"Herren"},{k:"kids",de:"Kinder"},{k:"acc",de:"Accessoires"}], filters: [] },
      services: { label: { de: "Dienstleistung", en: "Services", sq: "Sh√´rbime", sr: "Usluge", mk: "–£—Å–ª—É–≥–∏" }, subs: [{k:"craft",de:"Handwerk"},{k:"trans",de:"Transport"},{k:"tech",de:"IT/Tech"},{k:"edu",de:"Unterricht"}], filters: [] },
      home: { label: { de: "Haus & Garten", en: "Home & Garden", sq: "Sht√´pia", sr: "Kuƒáa", mk: "–î–æ–º" }, subs: [{k:"furn",de:"M√∂bel"},{k:"kitchen",de:"K√ºche"},{k:"garden",de:"Garten"},{k:"deco",de:"Deko"}], filters: [] }
    };

    // --- MAIN APP ---
    window.app = {
      lang: 'de', user: null, authMode: 'login', uploadSlot: -1,
      images: [null, null, null, null],

      init: () => {
        app.loadTheme();
        app.setLanguage('de'); 
        app.setupListeners('filter');
        app.setupListeners('sell');
        app.initAuthListener();
        app.loadListings();
        document.getElementById('upload-input').addEventListener('change', app.handleFileSelect);
        document.getElementById('avatar-input').addEventListener('change', app.handleAvatarUpload);
      },

      initAuthListener: () => {
        onAuthStateChanged(auth, async (user) => {
          app.user = user;
          const li = document.getElementById("profile-content-logged-in");
          const gu = document.getElementById("profile-content-guest");

          if (user) {
            li.style.display = "block";
            gu.style.display = "none";
            app.loadProfileData(); // Fetch Data
          } else {
            li.style.display = "none";
            gu.style.display = "block";
          }
        });
      },

      // --- AUTH ---
      openAuth: (mode) => {
        app.authMode = mode;
        document.getElementById('auth-modal').style.display = "flex";
        document.getElementById('auth-title').innerText = mode === 'login' ? 'Anmelden' : 'Registrieren';
        document.getElementById('btn-auth-action').innerText = mode === 'login' ? 'Einloggen' : 'Konto erstellen';
        document.getElementById('btn-auth-switch').innerText = mode === 'login' ? 'Kein Konto? Registrieren' : 'Hat Konto? Anmelden';
      },
      closeModal: (id) => { document.getElementById(id).style.display = "none"; },
      
      handleAuth: async () => {
        const email = document.getElementById('auth-email').value;
        const pass = document.getElementById('auth-pass').value;
        try {
          if (app.authMode === 'login') {
            await signInWithEmailAndPassword(auth, email, pass);
            app.showToast("Erfolgreich angemeldet!");
          } else {
            await createUserWithEmailAndPassword(auth, email, pass);
            app.showToast("Konto erstellt!");
          }
          app.closeModal('auth-modal');
        } catch (error) { app.showToast("Fehler: " + error.message); }
      },
      loginGoogle: async () => {
        try { await signInWithPopup(auth, googleProvider); app.showToast("Mit Google angemeldet!"); app.closeModal('auth-modal'); }
        catch (error) { app.showToast("Google Login Fehler: " + error.message); }
      },
      logout: async () => { await signOut(auth); app.showToast("Abgemeldet."); window.location.reload(); },

      // --- PROFILE DASHBOARD ---
      loadProfileData: async () => {
        if(!app.user) return;
        const ref = doc(db, "users", app.user.uid);
        const snap = await getDoc(ref);
        let data = {};
        
        if (snap.exists()) {
            data = snap.data();
        } else {
            // First time setup
            data = { email: app.user.email, displayName: app.user.displayName, photoURL: app.user.photoURL, privacy: 'registered' };
            await setDoc(ref, data, { merge: true });
        }

        // Update UI
        document.getElementById('dash-name').innerText = data.displayName || "Unbenannt";
        document.getElementById('dash-email').innerText = data.email || "";
        
        const av = document.getElementById('dash-avatar');
        if(data.photoURL) {
            av.style.backgroundImage = `url(${data.photoURL})`;
            av.innerText = "";
        } else {
            av.style.backgroundImage = "none";
            av.innerText = "üë§";
        }

        // Load My Listings Count & List
        const q = query(collection(db, "listings"), where("uid", "==", app.user.uid));
        const qSnap = await getDocs(q);
        document.getElementById('stat-listings').innerText = qSnap.size;
        
        const listContainer = document.getElementById('dash-listings-container');
        listContainer.innerHTML = "";
        qSnap.forEach(d => {
            const item = d.data();
            const div = document.createElement('div');
            div.className = "list-item";
            div.innerHTML = `
              <div style="display:flex; flex-direction:column;">
                <span style="font-weight:600">${item.title}</span>
                <span style="font-size:12px; color:var(--text-secondary)">${item.price} ‚Ç¨</span>
              </div>
              <button class="rai-btn danger small" onclick="app.deleteListing('${d.id}')">L√∂schen</button>
            `;
            listContainer.appendChild(div);
        });
      },

      openSettings: async () => {
        const ref = doc(db, "users", app.user.uid);
        const snap = await getDoc(ref);
        const data = snap.data() || {};
        document.getElementById('set-name').value = data.displayName || "";
        document.getElementById('set-phone').value = data.phone || "";
        document.getElementById('set-privacy').value = data.privacy || "registered";
        document.getElementById('settings-modal').style.display = "flex";
      },

      saveSettings: async () => {
        const name = document.getElementById('set-name').value;
        const phone = document.getElementById('set-phone').value;
        const priv = document.getElementById('set-privacy').value;
        
        try {
            await setDoc(doc(db, "users", app.user.uid), { displayName: name, phone: phone, privacy: priv }, { merge: true });
            app.showToast("Gespeichert!");
            app.closeModal('settings-modal');
            app.loadProfileData(); // Refresh UI
        } catch(e) { app.showToast("Fehler beim Speichern"); }
      },

      // --- AVATAR LOGIC ---
      triggerAvatarUpload: () => document.getElementById('avatar-input').click(),
      
      handleAvatarUpload: (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async (ev) => {
            // Simple compression
            const img = new Image();
            img.src = ev.target.result;
            img.onload = async () => {
                const cvs = document.createElement('canvas');
                const scale = 300 / img.width; // Small avatar
                cvs.width = 300; cvs.height = img.height * scale;
                const ctx = cvs.getContext('2d');
                ctx.drawImage(img,0,0,cvs.width,cvs.height);
                const base64 = cvs.toDataURL('image/jpeg', 0.6);
                
                // Save to Firestore
                await setDoc(doc(db, "users", app.user.uid), { photoURL: base64 }, { merge: true });
                app.loadProfileData();
                app.showToast("Profilbild aktualisiert!");
            };
        };
      },

      removeAvatar: async () => {
        if(!confirm("Bild entfernen?")) return;
        await setDoc(doc(db, "users", app.user.uid), { photoURL: null }, { merge: true });
        app.loadProfileData();
      },

      deleteListing: async (id) => {
        if(!confirm("Listing wirklich l√∂schen?")) return;
        await deleteDoc(doc(db, "listings", id));
        app.showToast("Gel√∂scht.");
        app.loadProfileData(); // Refresh Dashboard
        app.loadListings(); // Refresh Market
      },

      // --- LISTINGS & IMAGES ---
      triggerUpload: (index) => {
        app.uploadSlot = index;
        document.getElementById('upload-input').click();
      },
      handleFileSelect: (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 800;
                const scale = MAX_WIDTH / img.width;
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * scale;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                app.images[app.uploadSlot] = dataUrl;
                const boxes = document.querySelectorAll('.upload-box');
                const box = boxes[app.uploadSlot];
                box.innerHTML = `<img src="${dataUrl}">`;
                box.style.border = "none";
            };
        };
      },
      publishListing: async () => {
        if (!app.user) { app.showToast("Bitte erst anmelden!"); app.openAuth('login'); return; }
        const title = document.getElementById('sell-title').value;
        const price = document.getElementById('sell-price').value;
        const mainImage = app.images[0] || null; 
        if(!title || !price) { app.showToast("Titel & Preis fehlen!"); return; }
        try {
          await addDoc(collection(db, "listings"), {
            title: title, price: price, category: document.getElementById('sell-cat').value,
            subcategory: document.getElementById('sell-sub').value,
            country: document.getElementById('sell-country').value, desc: document.getElementById('sell-desc').value,
            image: mainImage, uid: app.user.uid, createdAt: new Date()
          });
          app.showToast("Inserat ver√∂ffentlicht!");
          document.getElementById('sell-title').value = "";
          app.images = [null,null,null,null];
          document.querySelectorAll('.upload-box').forEach(b => { b.innerHTML = "+"; b.style.border = ""; });
          document.querySelector('.upload-box.main').innerHTML = "üì∑";
          app.nav('market');
          app.loadListings();
        } catch (e) { app.showToast("Fehler: " + e.message); }
      },
      loadListings: async () => {
        let q = query(collection(db, "listings"), orderBy("createdAt", "desc"), limit(50));
        const country = document.getElementById('filter-country').value;
        if(country && country !== "all") { q = query(collection(db, "listings"), where("country", "==", country)); }
        
        const snapshot = await getDocs(q);
        const container = document.getElementById('market-listings');
        if (snapshot.empty) {
          container.innerHTML = `<div class="empty-state"><div class="empty-icon">üõí</div><div>Keine Angebote.<br><small>Sei der Erste!</small></div></div>`;
          return;
        }
        let html = '';
        snapshot.forEach(doc => {
          const data = doc.data();
          const imgHtml = data.image ? `<img src="${data.image}" style="width:100%; height:100%; object-fit:cover;">` : `<div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:30px;">üì∑</div>`;
          html += `<div class="rai-card" style="padding:0; cursor:pointer;"><div style="height:150px; background:var(--bg-input); position:relative;">${imgHtml}<div style="position:absolute; top:10px; right:10px; background:rgba(255,255,255,0.9); padding:2px 8px; border-radius:10px; font-size:10px; font-weight:bold;">${data.country || "Balkan"}</div></div><div style="padding:15px;"><div style="font-weight:700; font-size:16px; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${data.title}</div><div style="color:var(--accent); font-weight:700;">‚Ç¨ ${data.price}</div></div></div>`;
        });
        container.innerHTML = html;
      },

      nav: (view) => {
        window.scrollTo(0,0);
        ['market', 'sell', 'profile'].forEach(v => { document.getElementById('view-' + v).classList.add('hidden'); document.getElementById('tab-' + v).classList.remove('active'); });
        document.getElementById('view-' + view).classList.remove('hidden'); document.getElementById('tab-' + view).classList.add('active');
        if(view === 'profile' && app.user) app.loadProfileData(); // Refresh profile when clicking tab
      },
      showToast: (text) => {
        const c = document.getElementById('toast-container'); const el = document.createElement('div'); el.className = 'toast show'; el.innerText = text; c.appendChild(el);
        setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 300); }, 3000);
      },
      setLanguage: (langCode) => { app.lang = langCode; app.translatePage(); app.populateDropdowns('filter'); app.populateDropdowns('sell'); },
      translatePage: () => {
        const t = TRANSLATIONS[app.lang];
        document.querySelectorAll('[data-i18n]').forEach(el => { if (t[el.getAttribute('data-i18n')]) el.innerHTML = t[el.getAttribute('data-i18n')]; });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => { if (t[el.getAttribute('data-i18n-placeholder')]) el.placeholder = t[el.getAttribute('data-i18n-placeholder')]; });
      },
      populateDropdowns: (prefix) => {
        const lang = app.lang;
        const countrySel = document.getElementById(prefix + '-country'); countrySel.innerHTML = "";
        for (const code in COUNTRIES_DATA) { const opt = document.createElement('option'); opt.value = code; opt.textContent = COUNTRIES_DATA[code][lang] || COUNTRIES_DATA[code]['en']; countrySel.appendChild(opt); }
        const catSel = document.getElementById(prefix + '-cat'); catSel.innerHTML = "";
        for (const catKey in CATEGORIES_DATA) { const opt = document.createElement('option'); opt.value = catKey; opt.textContent = CATEGORIES_DATA[catKey].label[lang] || CATEGORIES_DATA[catKey].label['de']; catSel.appendChild(opt); }
      },
      setupListeners: (prefix) => {
        const catSel = document.getElementById(prefix + '-cat'); const subSel = document.getElementById(prefix + '-sub');
        catSel.addEventListener('change', () => {
           const val = catSel.value; const lang = app.lang; subSel.innerHTML = "";
           const def = document.createElement('option'); def.textContent = prefix === 'filter' ? TRANSLATIONS[lang].opt_all : TRANSLATIONS[lang].opt_choose; subSel.appendChild(def);
           if(CATEGORIES_DATA[val]) {
             subSel.disabled = false;
             CATEGORIES_DATA[val].subs.forEach(item => { const opt = document.createElement('option'); opt.value = item.k; opt.textContent = item[lang] || item['de']; subSel.appendChild(opt); });
             app.renderContextFilters(prefix, val, null);
           } else { subSel.disabled = true; app.renderContextFilters(prefix, null, null); }
        });
        subSel.addEventListener('change', () => { app.renderContextFilters(prefix, catSel.value, subSel.value); });
      },
      renderContextFilters: (prefix, categoryKey, subKey) => {
        const containerId = prefix === 'filter' ? 'dynamic-filters' : 'sell-dynamic-inputs';
        const container = document.getElementById(containerId);
        container.innerHTML = ""; container.style.display = "none"; container.classList.remove('show');
        if (!categoryKey || !CATEGORIES_DATA[categoryKey]) return;
        let filters = [...CATEGORIES_DATA[categoryKey].filters];
        if (categoryKey === 'realestate' && subKey && (subKey.includes('apt') || subKey.includes('house'))) { filters.push({ id: "filter_rooms" }); filters.push({ id: "filter_floor" }); }
        if (filters.length === 0) return;
        const lang = app.lang; const t = TRANSLATIONS[lang];
        if (prefix === 'filter') {
          container.style.display = "block"; setTimeout(() => container.classList.add('show'), 10);
          let html = '<div class="grid-2">';
          filters.forEach(f => { const label = t[f.id] || f.id; html += `<div class="rai-input-group" style="margin:0"><label class="rai-label">${label}</label><input type="number" class="rai-input" placeholder="0"></div>`; });
          html += '</div>'; container.innerHTML = html;
        } else {
          container.style.display = "grid";
          filters.forEach(f => { const label = t[f.id] || f.id; const div = document.createElement('div'); div.className = "rai-input-group"; div.innerHTML = `<label class="rai-label">${label}</label><input type="number" class="rai-input" placeholder="0">`; container.appendChild(div); });
        }
      },
      loadTheme: () => { const saved = localStorage.getItem('theme') || 'light'; document.documentElement.setAttribute('data-theme', saved); document.getElementById('theme-icon').textContent = saved === 'dark' ? '‚òÄÔ∏è' : 'üåô'; },
      toggleTheme: () => { const current = document.documentElement.getAttribute('data-theme'); const next = current === 'dark' ? 'light' : 'dark'; document.documentElement.setAttribute('data-theme', next); localStorage.setItem('theme', next); document.getElementById('theme-icon').textContent = next === 'dark' ? '‚òÄÔ∏è' : 'üåô'; }
    };

    document.getElementById('btn-auth-switch').addEventListener('click', () => { app.openAuth(app.authMode === 'login' ? 'register' : 'login'); });
    document.getElementById('btn-auth-action').addEventListener('click', app.handleAuth);

    app.init();
  </script>
</body>
</html>
